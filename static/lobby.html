<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Poker Lobby</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        background: #1a2b3c;
        color: white;
        margin: 0;
        padding: 0;
      }

      .container {
        max-width: 1200px;
        margin: 0 auto;
        padding: 20px;
      }

      h1 {
        text-align: center;
        color: #f8c471;
        margin-bottom: 20px;
      }

      .lobby-info {
        background-color: rgba(0, 0, 0, 0.3);
        border-radius: 5px;
        padding: 15px;
        margin-bottom: 20px;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .player-info {
        font-size: 18px;
      }

      .action-panel {
        display: flex;
        gap: 10px;
        margin-bottom: 20px;
      }

      button {
        background-color: #2e86c1;
        color: white;
        border: none;
        padding: 12px 20px;
        border-radius: 5px;
        cursor: pointer;
        font-size: 16px;
        transition: background-color 0.3s;
      }

      button:hover {
        background-color: #3498db;
      }

      button.ready-btn {
        background-color: #27ae60;
      }

      button.ready-btn:hover {
        background-color: #2ecc71;
      }

      button.quit-btn {
        background-color: #c0392b;
      }

      button.quit-btn:hover {
        background-color: #e74c3c;
      }

      .panel {
        background-color: rgba(0, 0, 0, 0.3);
        border-radius: 5px;
        padding: 15px;
        margin-bottom: 20px;
      }

      .panel-header {
        font-size: 18px;
        font-weight: bold;
        margin-bottom: 10px;
        color: #f8c471;
        border-bottom: 1px solid #f8c471;
        padding-bottom: 5px;
      }

      .player-list {
        list-style-type: none;
        padding: 0;
      }

      .player-list li {
        padding: 8px;
        border-bottom: 1px solid rgba(255, 255, 255, 0.1);
      }

      .player-list li:last-child {
        border-bottom: none;
      }

      .player-ready {
        color: #2ecc71;
      }

      .player-not-ready {
        color: #e74c3c;
      }

      .response {
        background-color: rgba(0, 0, 0, 0.5);
        padding: 10px;
        margin: 10px 0;
        border-radius: 5px;
        min-height: 30px;
      }

      .game-rules {
        white-space: pre-line;
      }

      .stats-container {
        display: flex;
        justify-content: space-between;
      }

      .stats-item {
        text-align: center;
        flex: 1;
        padding: 10px;
      }

      .stats-value {
        font-size: 24px;
        font-weight: bold;
        color: #f8c471;
      }

      .stats-label {
        font-size: 14px;
        color: #bdc3c7;
      }

      /* Rules modal styling */
      .modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.7);
        z-index: 100;
        justify-content: center;
        align-items: center;
      }

      .modal-content {
        background-color: #2c3e50;
        border-radius: 8px;
        width: 80%;
        max-width: 800px;
        max-height: 80vh;
        padding: 20px;
        position: relative;
      }

      .close-button {
        position: absolute;
        top: 10px;
        right: 15px;
        font-size: 24px;
        color: #e74c3c;
        cursor: pointer;
        background: none;
        border: none;
        padding: 0;
      }

      .rules-iframe {
        width: 100%;
        height: 500px;
        border: none;
        background-color: white;
      }

      /* Game iframe styling */
      .game-container {
        width: 100%;
        height: 500px;
        margin-top: 20px;
        border-radius: 8px;
        overflow: hidden;
        box-shadow: 0 0 20px rgba(0, 0, 0, 0.5);
      }

      .game-iframe {
        width: 100%;
        height: 100%;
        border: none;
        /* Remove the background color so it doesn't show green */
        background-color: transparent;
        position: relative;
        z-index: 2;
      }

      /* Layout for when game is active */
      .game-active .top-row {
        display: flex;
        gap: 20px;
        margin-bottom: 20px;
      }

      .game-active .top-row .panel {
        flex: 1;
        margin-bottom: 0;
      }

      .row {
        display: flex;
        gap: 20px;
      }

      .col {
        flex: 1;
      }

      /* Add to existing styles */
      /* Game active state adjustments */
      .game-active .container {
        display: flex;
        flex-direction: column;
      }
      
      .game-active .info-panel {
        flex: 2;
      }
      
      .game-active .stats-panel {
        flex: 3;
      }
      
      .game-active .game-container {
        /* No need for display: block here since we want it always visible */
        height: 500px;
        margin-bottom: 15px;
      }
      
      .game-active .player-panel {
        margin-top: 10px;
      }
      
      .game-active .lobby-controls {
        display: none;
      }

      .hidden {
        display: none !important;
      }
      
      .panel.minimized {
        padding: 10px;
      }
      
      .panel.minimized .panel-header {
        margin-bottom: 0;
        padding-bottom: 0;
        border-bottom: none;
      }

      .panel-toggle {
        float: right;
        cursor: pointer;
        user-select: none;
      }

      .game-loading {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        display: flex;
        justify-content: center;
        align-items: center;
        background-color: #15803d;
        color: white;
        font-size: 20px;
        z-index: 1;
      }

      .betting-controls {
        display: flex;
        flex-direction: column;
        padding: 15px;
        background-color: rgba(0, 0, 0, 0.3);
        border-radius: 5px;
        margin-top: 15px;
        width: 100%;
      }
      
      .betting-info {
        display: flex;
        justify-content: space-between;
        margin-bottom: 15px;
        padding: 10px;
        background-color: rgba(0, 0, 0, 0.2);
        border-radius: 5px;
      }
      
      .info-item {
        display: flex;
        flex-direction: column;
        align-items: center;
      }
      
      .info-label {
        font-size: 12px;
        color: #bdc3c7;
      }
      
      .info-value {
        font-size: 18px;
        font-weight: bold;
        color: #f8c471;
      }
      
      .action-buttons {
        display: flex;
        justify-content: space-around;
        gap: 8px;
        margin-bottom: 15px;
      }
      
      .action-btn {
        flex: 1;
        padding: 10px;
        min-width: 70px;
      }
      
      .action-btn.disabled {
        opacity: 0.5;
        cursor: not-allowed;
      }
      
      .raise-controls {
        display: flex;
        flex-direction: column;
        align-items: center;
        padding: 10px;
        background-color: rgba(0, 0, 0, 0.2);
        border-radius: 5px;
      }
      
      #raiseSlider {
        width: 100%;
        margin-bottom: 10px;
      }
      
      .raise-amount-display {
        font-size: 20px;
        font-weight: bold;
        color: #f8c471;
        margin-bottom: 10px;
      }
      
      .raise-buttons {
        display: flex;
        gap: 10px;
        width: 100%;
      }
      
      .confirm-btn, .cancel-btn {
        flex: 1;
        padding: 8px;
      }
      
      .confirm-btn {
        background-color: #27ae60;
      }
      
      .cancel-btn {
        background-color: #7f8c8d;
      }
    </style>
  </head>
  <body>
    <div class="container" id="mainContainer">
      <h1 id="lobbyTitle">Game Lobby</h1>

      <div class="lobby-info">
        <div class="player-info" id="playerCount">Players: 0/0</div>
        <div class="player-info" id="gameType">Game Type: Loading...</div>
      </div>

      <div class="response" id="response"></div>

      <div class="action-panel lobby-controls" id="lobbyControls">
        <button onclick="readyUp()" class="ready-btn" id="readyButton">
          Ready Up
        </button>
        <button onclick="showRules()" class="rules-btn">Rules</button>
        <button onclick="quitLobby()" class="quit-btn">Leave Lobby</button>
      </div>

      <div class="top-section" id="topSection">
        <div class="col info-panel">
          <div class="panel">
            <div class="panel-header">Players in Lobby <span class="panel-toggle" id="playerListToggle">[-]</span></div>
            <div id="playerListContent">
              <ul class="player-list" id="playerList">
                <li>Loading players...</li>
              </ul>
            </div>
          </div>
        </div>
        <div class="col stats-panel">
          <div class="panel" id="statsPanel">
            <div class="panel-header">Your Statistics <span class="panel-toggle" id="statsToggle">[-]</span></div>
            <div id="statsContent">
              <div class="stats-container">
                <div class="stats-item">
                  <div class="stats-value" id="gamesPlayed">0</div>
                  <div class="stats-label">Games Played</div>
                </div>
                <div class="stats-item">
                  <div class="stats-value" id="gamesWon">0</div>
                  <div class="stats-label">Games Won</div>
                </div>
                <div class="stats-item">
                  <div class="stats-value" id="winRate">0%</div>
                  <div class="stats-label">Win Rate</div>
                </div>
                <div class="stats-item">
                  <div class="stats-value" id="wallet">$0</div>
                  <div class="stats-label">Wallet</div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Game iframe container -->
      <div class="game-container" id="gameContainer">
        <div id="gameLoading" class="game-loading">Loading poker table...</div>
        <iframe id="gameFrame" class="game-iframe" src="about:blank"></iframe>
      </div>

      <!-- Game controls appear when game is active -->
      <div class="action-panel game-controls hidden" id="gameControls">
        <button onclick="showRules()" class="rules-btn">Rules</button>
        <button onclick="quitLobby()" class="quit-btn">Leave Game</button>
        
        <div id="bettingControls" class="betting-controls hidden">
          <div class="betting-info">
            <div class="info-item">
              <span class="info-label">Your Chips:</span>
              <span class="info-value" id="playerChips">$0</span>
            </div>
            <div class="info-item">
              <span class="info-label">To Call:</span>
              <span class="info-value" id="callAmount">$0</span>
            </div>
            <div class="info-item">
              <span class="info-label">Current Pot:</span>
              <span class="info-value" id="currentPot">$0</span>
            </div>
          </div>
          
          <div class="action-buttons">
            <button id="checkBtn" onclick="gameAction('Check')" class="action-btn">Check</button>
            <button id="callBtn" onclick="gameAction('Call')" class="action-btn">Call</button>
            <button id="foldBtn" onclick="gameAction('Fold')" class="action-btn">Fold</button>
            <button id="allInBtn" onclick="gameAction('AllIn')" class="action-btn">All In</button>
            <button id="raiseBtn" onclick="showRaiseControls()" class="action-btn">Raise</button>
          </div>
          
          <div id="raiseControls" class="raise-controls hidden">
            <input type="range" id="raiseSlider" min="1" max="100" value="10" oninput="updateRaiseAmount()">
            <div class="raise-amount-display">
              <span>$</span><span id="raiseAmount">10</span>
            </div>
            <div class="raise-buttons">
              <button onclick="gameAction('Raise')" class="confirm-btn">Confirm Raise</button>
              <button onclick="hideRaiseControls()" class="cancel-btn">Cancel</button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Rules Modal -->
    <div id="rulesModal" class="modal">
      <div class="modal-content">
        <button class="close-button" onclick="closeRules()">&times;</button>
        <h2>Game Rules</h2>
        <iframe id="rulesFrame" class="rules-iframe" src="about:blank"></iframe>
      </div>
    </div>

    <script>
      const responseDiv = document.getElementById("response");
      const playerCountDiv = document.getElementById("playerCount");
      const gameTypeDiv = document.getElementById("gameType");
      const playerListElement = document.getElementById("playerList");
      const lobbyTitle = document.getElementById("lobbyTitle");
      const readyButton = document.getElementById("readyButton");
      const rulesModal = document.getElementById("rulesModal");
      const rulesFrame = document.getElementById("rulesFrame");
      const mainContainer = document.getElementById("mainContainer");
      const gameContainer = document.getElementById("gameContainer");
      const gameFrame = document.getElementById("gameFrame");
      const lobbyControls = document.getElementById("lobbyControls");

      let isReady = false;
      let currentLobbyInfo = null;
      let gameActive = false;

      // Add these constants for the new UI elements
      const topSection = document.getElementById("topSection");
      const playerListToggle = document.getElementById("playerListToggle");
      const statsToggle = document.getElementById("statsToggle");
      const playerListContent = document.getElementById("playerListContent");
      const statsContent = document.getElementById("statsContent");
      const gameControls = document.getElementById("gameControls");
      const bettingControls = document.getElementById("bettingControls");
      const raiseControls = document.getElementById("raiseControls");
      const raiseSlider = document.getElementById("raiseSlider");
      const raiseAmountDisplay = document.getElementById("raiseAmount");

      // Add these new variables at the top of your script section
      let playerTurn = false;
      let gameState = {
        playerChips: 0,
        callAmount: 0,
        currentPot: 0,
        canCheck: false,
        canRaise: false
      };

      // Update the game rule URLs to use Wikipedia
      const gameRuleUrls = {
        "5 Card Draw": "https://en.wikipedia.org/wiki/Five-card_draw",
        "7 Card Stud": "https://en.wikipedia.org/wiki/Seven-card-stud",
        "Texas Hold'em": "https://en.wikipedia.org/wiki/Texas_hold_%27em"
      };
      
      // Map game types to their corresponding HTML files
      const gameHtmlFiles = {
        "5 Card Draw": "five_card.html",
        "7 Card Stud": "seven_card.html",
        "Texas Hold'em": "texas_holdem.html" 
      };

      // Update the window.onload function
      window.onload = function () {
        // Check if we have a stored game type
        const storedGameType = localStorage.getItem('currentGameType');
        if (storedGameType) {
          console.log("Found stored game type:", storedGameType);
          currentLobbyInfo = currentLobbyInfo || {};
          currentLobbyInfo.gameType = storedGameType;
          
          // Initialize the game iframe with the appropriate game
          loadGameFrame(storedGameType);
        } else {
          // Default to 5 Card Draw if no stored game type
          loadGameFrame("5 Card Draw");
        }
        
        refreshLobbyInfo();
        refreshStats();
      
        // Set up periodic refresh
        setInterval(() => {
          updateInput();
        }, 100);
      };

      // Add this function to load the appropriate game iframe
      function loadGameFrame(gameType) {
        const gameFrame = document.getElementById("gameFrame");
        let gameUrl = "five_card.html"; // Default
        
        // Show loading indicator
        document.getElementById("gameLoading").style.display = "flex";
        
        // Clear any existing content first
        gameFrame.src = "about:blank";
        
        // Give a small delay before loading new content
        setTimeout(() => {
          if (gameType.toLowerCase().includes("texas") || gameType.toLowerCase().includes("hold")) {
            gameUrl = "texas_holdem.html";
          } else if (gameType.toLowerCase().includes("7") || gameType.toLowerCase().includes("stud")) {
            gameUrl = "seven_card.html";
          } else if (gameType.toLowerCase().includes("5") || gameType.toLowerCase().includes("draw")) {
            gameUrl = "five_card.html";
          }
          
          console.log(`Loading game frame: ${gameUrl} for type: ${gameType}`);
          // Load the file from /static/ directory instead of the root path
          gameFrame.src = `/static/${gameUrl}`;
          
          // Add event listener to detect load errors
          gameFrame.onerror = function() {
            console.error(`Failed to load game frame: ${gameUrl}`);
            document.getElementById("gameLoading").textContent = 
              `Error loading game. Please refresh the page.`;
          };
          
          // Add onload handler to hide loading message
          gameFrame.onload = function() {
            document.getElementById("gameLoading").style.display = "none";
            console.log(`Successfully loaded game frame: ${gameUrl}`);
          };
        }, 100);
      }

      // Handle WebSocket messages from parent frame
      window.addEventListener("message", (event) => {
      console.log("Lobby received message:", event.data);
      
      // Forward 'sendWebSocket' messages directly to index.html
      if (event.data.type === "sendWebSocket") {
        console.log("Forwarding to server:", event.data.data);
        window.parent.postMessage(event.data, "*");
      }
      else if (event.data.type === "websocket") {
        handleMessage(event.data.data);
      }
    });

      // Update the handleMessage function to detect player turn and betting state
      function handleMessage(data) {
        try {
          const response = JSON.parse(data);
          console.log("Handling message:", response);

          if (response.message) {
            responseDiv.innerText = response.message;
            setTimeout(() => {
              responseDiv.innerText = "";
            }, 5000);
          }

          if (response.redirect) {
            // Navigate using parent frame
            window.parent.navigate(response.redirect);
          }

          // Handle player list
          if (response.players) {
            console.log("Updating player list:", response);
            updatePlayerList(response.players, response.spectators);
            // Check if all players are ready
            if(!gameActive) {
              checkAllPlayersReady(response.players);
            }
          }

          // Handle lobby info
          if (response.lobbyInfo) {
            updateLobbyInfo(response.lobbyInfo);
          }

          // Handle game info and player turn
          if (response.gameInfo) {
            console.log("Game info received:", response.gameInfo);
            
            // Update game state
            if (response.gameInfo.pot !== undefined) {
              gameState.currentPot = response.gameInfo.pot;
              document.getElementById("currentPot").textContent = "$" + gameState.currentPot;
            }
            
            // Check if it's this player's turn
            const playerName = localStorage.getItem('currentPlayerName');
            playerTurn = (response.gameInfo.currentPlayerTurn === playerName);
            const game_state = response.gameInfo.gameState;
            isBettingRound = (game_state == 14 || game_state == 15 || game_state == 16 || game_state == 19);

            console.log("Player turn:", playerTurn, "Is betting round:", isBettingRound);
            
            // If it's the player's turn, update the betting controls
            if (playerTurn && isBettingRound) {
              responseDiv.innerText = "It's your turn!";
              
              // Update betting info
              gameState.callAmount = response.gameInfo.currentMaxBet || 0;
              document.getElementById("callAmount").textContent = "$" + gameState.callAmount;
              
              // Show betting controls
              document.getElementById("bettingControls").classList.remove("hidden");
              
              // Determine valid actions based on game state
              updateValidActions();
            } else {
              // Hide betting controls when it's not player's turn
              document.getElementById("bettingControls").classList.add("hidden");
            }
            
            // Update game iframe
            sendGameCommand("updateGameInfo", response.gameInfo);
          }

          // Update player stats which includes wallet/chips
          if (response.stats) {
            updateStats(response.stats);
            
            // Update the player chips for betting controls
            gameState.playerChips = response.stats.wallet;
            document.getElementById("playerChips").textContent = "$" + gameState.playerChips;
            
            // Update valid actions based on new chip amount
            if (playerTurn) {
              updateValidActions();
            }
          }

          // In your handleMessage function, add handling for showdownHands type
          if (response.command === "showdownHands") {
            console.log("Lobby received showdown data:", response);
            sendGameCommand("showdownHands", response.data); // Make sure we're sending the nested data
          }

          // Inside your handleMessage function, add this condition
          if (response.gameInfo && response.gameInfo.gameState === 0) { // Assuming 0 = game over/not started
            // Check if we were previously in an active game
            if (gameActive) {
              console.log("Game has ended");
              endGame();
            }
          }

          // Also check for explicit game end message
          if (response.gameEnd === true) {
            console.log("Received game end notification");
            endGame();
          }
        } catch (e) {
          console.error("Error parsing message:", e);
          
          // Check for non-JSON messages about turns
          if (typeof data === 'string') {
            if (data.includes("Your turn") && data.includes("betting round")) {
              playerTurn = true;
              document.getElementById("bettingControls").classList.remove("hidden");
              responseDiv.innerText = data;
              updateValidActions();
            } else {
              // Refresh game state when a betting round starts
              sendToServer(JSON.stringify({ action: "ShowStats" }));
            }
          }
        }
      }

      function updatePlayerList(players, spectators) {
        playerListElement.innerHTML = "";

        if (players.length === 0) {
          playerListElement.innerHTML = "<li>No players in lobby</li>";
          return;
        }

        players.forEach((player) => {
          const li = document.createElement("li");
          li.innerHTML = `${player.name} <span class="${
            player.ready ? "player-ready" : "player-not-ready"
          }">(${player.ready ? "Ready" : "Not Ready"})</span>`;
          playerListElement.appendChild(li);
        });
        
        // Send player data to the game iframe
        console.log("Sending player data to game iframe:", players);
        sendGameCommand("updatePlayers", { players: players, spectators: spectators, gameActive: gameActive });
      }
      
      function checkAllPlayersReady(players) {
        // Only check if game isn't already active
        if (gameActive) return;
        
        if (players.length >= 2) {
          const allReady = players.every(player => player.ready);
          if (allReady) {
            console.log("Starting game with players:", players);
            console.log("Starting lobby info:", currentLobbyInfo);
            startGame(players);
          }
        }
      }
      
      // Modified startGame function
      function startGame(players) {
        sendToServer(JSON.stringify({ action: "StartGame" }));
        if (gameActive) return; // Prevent multiple starts
        
        gameActive = true;
        
        // Update UI elements
        mainContainer.classList.add("game-active");
        mainContainer.classList.remove("game-finished");
        lobbyControls.classList.add("hidden");
        gameControls.classList.remove("hidden");

        isReady = false;
        readyButton.textContent = "Ready Up";
        readyButton.style.backgroundColor = "#27ae60";
        
        // Hide the entire top section containing player list and stats panels
        topSection.classList.add("hidden");
        
        // Hide betting controls initially - they'll show when it's the player's turn
        document.getElementById("bettingControls").classList.add("hidden");
        
        // Send a message to the game iframe to start the game
        sendGameCommand("startGame", {
          players: players,
          gameType: currentLobbyInfo.gameType,
          pot: 0
        });
        
        // Get player stats to initialize chip count
        refreshStats();
        
        console.log(`Game started: ${currentLobbyInfo.gameType}`);
      }

      // Add this function to send messages to the game iframe
      function sendGameCommand(command, data) {
        const gameFrame = document.getElementById("gameFrame");
        if (gameFrame && gameFrame.contentWindow) {
          gameFrame.contentWindow.postMessage({
            type: "command",
            command: command,
            data: data
          }, "*");
        }
      }

      function updateLobbyInfo(info) {
        // Check if game type has changed
        const gameTypeChanged = currentLobbyInfo?.gameType !== info.gameType;
        
        // Update current lobby info
        currentLobbyInfo = info;
        lobbyTitle.textContent = info.name;
        playerCountDiv.textContent = `Players: ${info.playerCount}/${info.maxPlayers}`;
        gameTypeDiv.textContent = `Game Type: ${info.gameType}`;
        
        // Save game type to localStorage
        if (info.gameType) {
          localStorage.setItem('currentGameType', info.gameType);
          console.log("Saved game type to localStorage:", info.gameType);
        }
        
        // If game type changed, reload the appropriate game frame
        if (gameTypeChanged) {
          loadGameFrame(info.gameType);
        }
        
        // Send updated player list to the game frame
        if (info.players) {
          sendGameCommand("updatePlayers", {
            players: info.players
          });
        }
        
        // Add debugging output
        debugLobbyInfo();
      }

      // Update stats function to also update the betting chips display
      function updateStats(stats) {
        document.getElementById("gamesPlayed").textContent = stats.gamesPlayed;
        document.getElementById("gamesWon").textContent = stats.gamesWon;
        document.getElementById("wallet").textContent = `$${stats.wallet}`;

        // Calculate win rate
        const winRate =
          stats.gamesPlayed > 0
            ? Math.round((stats.gamesWon / stats.gamesPlayed) * 100)
            : 0;
        document.getElementById("winRate").textContent = `${winRate}%`;
        
        // Update player chips for betting UI
        gameState.playerChips = stats.wallet;
        document.getElementById("playerChips").textContent = "$" + gameState.playerChips;
      }

      function readyUp() {
        sendToServer(JSON.stringify({ action: "Ready" }));
        isReady = !isReady;
        readyButton.textContent = isReady ? "Cancel Ready" : "Ready Up";
        readyButton.style.backgroundColor = isReady ? "#c0392b" : "#27ae60";
      }

      function refreshStats() {
        sendToServer(JSON.stringify({ action: "ShowStats" }));
      }

      function quitLobby() {
        // Clear the stored game type when leaving the lobby
        localStorage.removeItem('currentGameType');
        sendToServer(JSON.stringify({ action: "Quit" }));
      }
      
      function refreshLobby() {
        sendToServer(JSON.stringify({ action: "ShowPlayers" }));
      }

      function refreshLobbyInfo() {
        sendToServer(JSON.stringify({ action: "ShowLobbyInfo" }));
      }

      function updateInput(){
        sendToServer(JSON.stringify({ action: "UpdateInput" }));
      }

      // Function to update which action buttons are valid
      function updateValidActions() {
        // Check if player can check (only if callAmount is 0)
        gameState.canCheck = (gameState.callAmount === 0);
        document.getElementById("checkBtn").disabled = !gameState.canCheck;
        document.getElementById("checkBtn").classList.toggle("disabled", !gameState.canCheck);
        
        // Check if player can call (must have enough chips and there must be something to call)
        const canCall = (gameState.callAmount > 0 && gameState.playerChips >= gameState.callAmount);
        document.getElementById("callBtn").disabled = !canCall;
        document.getElementById("callBtn").classList.toggle("disabled", !canCall);
        
        // Check if player can raise (must have enough chips to call plus more to raise)
        gameState.canRaise = (gameState.playerChips > gameState.callAmount);
        document.getElementById("raiseBtn").disabled = !gameState.canRaise;
        document.getElementById("raiseBtn").classList.toggle("disabled", !gameState.canRaise);
        
        // Update raise slider limits if raising is possible
        if (gameState.canRaise) {
          const minRaise = Math.max(gameState.callAmount + 1, 1);
          const maxRaise = gameState.playerChips;
          
          const raiseSlider = document.getElementById("raiseSlider");
          raiseSlider.min = minRaise;
          raiseSlider.max = maxRaise;
          raiseSlider.value = minRaise;
          document.getElementById("raiseAmount").textContent = minRaise;
        }
        
        // Player can always fold
        document.getElementById("foldBtn").disabled = false;
        document.getElementById("foldBtn").classList.remove("disabled");
        
        // Player can go all-in if they have any chips
        const canAllIn = (gameState.playerChips > 0);
        document.getElementById("allInBtn").disabled = !canAllIn;
        document.getElementById("allInBtn").classList.toggle("disabled", !canAllIn);
        
        // If player can't call the current bet but has chips, only allow fold or all-in
        if (gameState.callAmount > gameState.playerChips && gameState.playerChips > 0) {
          document.getElementById("checkBtn").disabled = true;
          document.getElementById("checkBtn").classList.add("disabled");
          document.getElementById("callBtn").disabled = true;
          document.getElementById("callBtn").classList.add("disabled");
          document.getElementById("raiseBtn").disabled = true;
          document.getElementById("raiseBtn").classList.add("disabled");
          
          // Show a message that player can only fold or go all-in
          responseDiv.innerText = "You don't have enough chips to call. You can fold or go all-in.";
        }
      }

      // Show raise controls when the Raise button is clicked
      function showRaiseControls() {
        document.getElementById("raiseControls").classList.remove("hidden");
        
        // Set the initial raise amount
        updateRaiseAmount();
      }

      // Hide raise controls
      function hideRaiseControls() {
        document.getElementById("raiseControls").classList.add("hidden");
      }

      // Update raise amount display when slider changes
      function updateRaiseAmount() {
        const value = document.getElementById("raiseSlider").value;
        document.getElementById("raiseAmount").textContent = value;
      }

      // Update the gameAction function
      function gameAction(action) {
        let message;
        let betAmount = 0;
        if (action === "Check" && gameState.canCheck) {
          message = { action: "Check" };
        } else if (action === "Call") {
          message = { action: "Call" };
        } else if (action === "Fold") {
          message = { action: "Fold" };
        } else if (action === "AllIn") {
          message = { action: "AllIn" };
        } else if (action === "Raise" && gameState.canRaise) {
          // Make sure we get a clean integer value
          const amount = parseInt(document.getElementById("raiseAmount").textContent.trim(), 10);
          console.log("Attempting to raise with amount:", amount);
          
          if (amount && amount <= gameState.playerChips && amount > gameState.callAmount) {
            message = { 
              action: "Raise", 
              data: {amount: parseInt(amount)}  // Send as a number, not a string
            };
            // sendToServer(
            //     JSON.stringify({
            //       action: "Raise",
            //       data: {
            //         amount: parseInt(amount)
            //       },
            //     })
            //   );        
            hideRaiseControls();
          } else {
            responseDiv.innerText = "Invalid raise amount! Must be greater than current call amount.";
            return;
          }
        } else {
          responseDiv.innerText = "This action is not available right now.";
          return;
        }
        // After sending action, disable all buttons to prevent multiple actions
        document.querySelectorAll('.action-btn').forEach(btn => {
          btn.disabled = true;
          btn.classList.add('disabled');
        });
        
        // Hide the raising controls if they're open
        hideRaiseControls();
        
        // Hide betting controls after taking action
        document.getElementById("bettingControls").classList.add("hidden");
        
        // Set playerTurn to false to indicate the player has taken their turn
        playerTurn = false;
        // if (action !== "Raise") {
        // } else {
          
        // }
        sendToServer(JSON.stringify(message));
        responseDiv.innerText = `You chose to ${action}${action === "Raise" ? " to $" + message.amount : ""}`;
      }

      function showRules() {
        // First try to get game type from currentLobbyInfo
        let gameType = currentLobbyInfo?.gameType;
        
        // If not available, try localStorage
        if (!gameType) {
          gameType = localStorage.getItem('currentGameType');
        }
        
        console.log("Getting rules for game type:", gameType);
        
        let ruleUrl = "https://en.wikipedia.org/wiki/Five-card_draw"; // Default
        
        if (gameType) {
          // Direct match with our known types
          if (gameRuleUrls[gameType]) {
            ruleUrl = gameRuleUrls[gameType];
            console.log("Direct match found for game type:", gameType);
          } 
          // Try Texas Hold'em with different variations
          else if (gameType.toLowerCase().includes("texas") || gameType.toLowerCase().includes("hold")) {
            ruleUrl = "https://en.wikipedia.org/wiki/Texas_hold_%27em";
            console.log("Texas Hold'em variation detected");
          }
          // Try 7 Card Stud with different variations  
          else if (gameType.toLowerCase().includes("7") || gameType.toLowerCase().includes("stud")) {
            ruleUrl = "https://en.wikipedia.org/wiki/Seven-card-stud";
            console.log("7 Card Stud variation detected");
          }
          // Try 5 Card Draw with different variations
          else if (gameType.toLowerCase().includes("5") || gameType.toLowerCase().includes("draw")) {
            ruleUrl = "https://en.wikipedia.org/wiki/Five-card-draw";
            console.log("5 Card Draw variation detected");
          }
          else {
            console.log("No specific match found for type:", gameType);
          }
        } else {
          console.log("No game type available, using default rules");
        }
        
        // Set the iframe source to the Wikipedia URL
        console.log("Setting iframe src to:", ruleUrl);
        rulesFrame.src = ruleUrl;
        rulesModal.style.display = "flex";
      }

      function closeRules() {
        rulesModal.style.display = "none";
      }

      // Send messages through parent using postMessage
      function sendToServer(message) {
        // Parse message to check action type
        const parsedMessage = JSON.parse(message);
        if (parsedMessage.action !== "UpdateInput") {
          console.log("Sending to server:", parsedMessage);
        }
        window.parent.postMessage(
          {
            type: "sendWebSocket",
            data: message,
          },
          "*"
        );
      }

      // Close rules modal when clicking outside of it
      window.onclick = function (event) {
        if (event.target === rulesModal) {
          closeRules();
        }
      };

      // Add this function for debugging purposes
      function debugLobbyInfo() {
        console.log("Current Lobby Info:", currentLobbyInfo);
        if (currentLobbyInfo && currentLobbyInfo.gameType) {
          console.log("Game Type:", currentLobbyInfo.gameType);
          console.log("Game Rule URL:", gameRuleUrls[currentLobbyInfo.gameType] || "Not found");
        }
      }

      // Add toggle functionality for panels
      playerListToggle.addEventListener("click", function() {
        togglePanel(playerListContent, playerListToggle);
      });

      statsToggle.addEventListener("click", function() {
        togglePanel(statsContent, statsToggle);
      });

      function togglePanel(contentElement, toggleElement) {
        const isOpen = contentElement.style.display !== "none";
        
        if (isOpen) {
          contentElement.style.display = "none";
          toggleElement.textContent = "[+]";
          toggleElement.parentElement.parentElement.classList.add("minimized");
        } else {
          contentElement.style.display = "block";
          toggleElement.textContent = "[-]";
          toggleElement.parentElement.parentElement.classList.remove("minimized");
        }
      }

      // Add this to the lobby.html script
      gameFrame.onload = function() {
        // Hide loading message when iframe loads
        document.getElementById("gameLoading").style.display = "none";
      };

      // Modified endGame function
      function endGame() {
        gameActive = false;
        
        // Update UI elements
        mainContainer.classList.remove("game-active");
        mainContainer.classList.add("game-finished");
        lobbyControls.classList.remove("hidden");
        gameControls.classList.add("hidden");
        
        // Show the top section again when returning to lobby
        topSection.classList.remove("hidden");
        
        // Refresh lobby data
        refreshLobbyInfo();
        refreshStats();
        
        console.log("Game ended");
      }
    </script>
  </body>
</html>