<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Poker Lobby</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        background: #1a2b3c;
        color: white;
        margin: 0;
        padding: 0;
      }

      .container {
        max-width: 900px;
        margin: 0 auto;
        padding: 20px;
      }

      h1 {
        text-align: center;
        color: #f8c471;
        margin-bottom: 30px;
      }

      .lobby-info {
        background-color: rgba(0, 0, 0, 0.3);
        border-radius: 5px;
        padding: 15px;
        margin-bottom: 20px;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .player-info {
        font-size: 18px;
      }

      .action-panel {
        display: flex;
        gap: 10px;
        margin-bottom: 20px;
      }

      button {
        background-color: #2e86c1;
        color: white;
        border: none;
        padding: 12px 20px;
        border-radius: 5px;
        cursor: pointer;
        font-size: 16px;
        transition: background-color 0.3s;
      }

      button:hover {
        background-color: #3498db;
      }

      button.ready-btn {
        background-color: #27ae60;
      }

      button.ready-btn:hover {
        background-color: #2ecc71;
      }

      button.quit-btn {
        background-color: #c0392b;
      }

      button.quit-btn:hover {
        background-color: #e74c3c;
      }

      .panel {
        background-color: rgba(0, 0, 0, 0.3);
        border-radius: 5px;
        padding: 15px;
        margin-bottom: 20px;
      }

      .panel-header {
        font-size: 18px;
        font-weight: bold;
        margin-bottom: 10px;
        color: #f8c471;
        border-bottom: 1px solid #f8c471;
        padding-bottom: 5px;
      }

      .player-list {
        list-style-type: none;
        padding: 0;
      }

      .player-list li {
        padding: 8px;
        border-bottom: 1px solid rgba(255, 255, 255, 0.1);
      }

      .player-list li:last-child {
        border-bottom: none;
      }

      .player-ready {
        color: #2ecc71;
      }

      .player-not-ready {
        color: #e74c3c;
      }

      .response {
        background-color: rgba(0, 0, 0, 0.5);
        padding: 10px;
        margin: 10px 0;
        border-radius: 5px;
        min-height: 30px;
      }

      .game-rules {
        white-space: pre-line;
      }

      .stats-container {
        display: flex;
        justify-content: space-between;
      }

      .stats-item {
        text-align: center;
        flex: 1;
        padding: 10px;
      }

      .stats-value {
        font-size: 24px;
        font-weight: bold;
        color: #f8c471;
      }

      .stats-label {
        font-size: 14px;
        color: #bdc3c7;
      }

      /* Rules modal styling */
      .modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.7);
        z-index: 100;
        justify-content: center;
        align-items: center;
      }

      .modal-content {
        background-color: #2c3e50;
        border-radius: 8px;
        width: 80%;
        max-width: 800px;
        max-height: 80vh;
        padding: 20px;
        position: relative;
      }

      .close-button {
        position: absolute;
        top: 10px;
        right: 15px;
        font-size: 24px;
        color: #e74c3c;
        cursor: pointer;
        background: none;
        border: none;
        padding: 0;
      }

      .rules-iframe {
        width: 100%;
        height: 500px;
        border: none;
        background-color: white;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1 id="lobbyTitle">Game Lobby</h1>

      <div class="lobby-info">
        <div class="player-info" id="playerCount">Players: 0/0</div>
        <div class="player-info" id="gameType">Game Type: Loading...</div>
      </div>

      <div class="response" id="response"></div>

      <div class="action-panel">
        <button onclick="readyUp()" class="ready-btn" id="readyButton">
          Ready Up
        </button>
        <button onclick="refreshStats()" class="stats-btn">
          Refresh Stats
        </button>
        <button onclick="showRules()" class="rules-btn">Rules</button>
        <button onclick="quitLobby()" class="quit-btn">Leave Lobby</button>
      </div>

      <div class="panel">
        <div class="panel-header">Players in Lobby</div>
        <ul class="player-list" id="playerList">
          <li>Loading players...</li>
        </ul>
      </div>

      <div class="panel">
        <div class="panel-header">Your Statistics</div>
        <div class="stats-container">
          <div class="stats-item">
            <div class="stats-value" id="gamesPlayed">0</div>
            <div class="stats-label">Games Played</div>
          </div>
          <div class="stats-item">
            <div class="stats-value" id="gamesWon">0</div>
            <div class="stats-label">Games Won</div>
          </div>
          <div class="stats-item">
            <div class="stats-value" id="winRate">0%</div>
            <div class="stats-label">Win Rate</div>
          </div>
          <div class="stats-item">
            <div class="stats-value" id="wallet">$0</div>
            <div class="stats-label">Wallet</div>
          </div>
        </div>
      </div>
    </div>

    <!-- Rules Modal -->
    <div id="rulesModal" class="modal">
      <div class="modal-content">
        <button class="close-button" onclick="closeRules()">&times;</button>
        <h2>Game Rules</h2>
        <iframe id="rulesFrame" class="rules-iframe" src="about:blank"></iframe>
      </div>
    </div>

    <script>
      const responseDiv = document.getElementById("response");
      const playerCountDiv = document.getElementById("playerCount");
      const gameTypeDiv = document.getElementById("gameType");
      const playerListElement = document.getElementById("playerList");
      const lobbyTitle = document.getElementById("lobbyTitle");
      const readyButton = document.getElementById("readyButton");
      const rulesModal = document.getElementById("rulesModal");
      const rulesFrame = document.getElementById("rulesFrame");

      let isReady = false;
      let currentLobbyInfo = null;

      // Update the game rule URLs to use Wikipedia
      const gameRuleUrls = {
        "5 Card Draw": "https://en.wikipedia.org/wiki/Five-card_draw",
        "7 Card Stud": "https://en.wikipedia.org/wiki/Seven-card_stud",
        "Texas Hold'em": "https://en.wikipedia.org/wiki/Texas_hold_%27em"
      };

      window.onload = function () {
        // Check if we have a stored game type from the server lobby
        const storedGameType = localStorage.getItem('currentGameType');
        if (storedGameType) {
          console.log("Found stored game type:", storedGameType);
          // Initialize currentLobbyInfo with the stored game type
          currentLobbyInfo = currentLobbyInfo || {};
          currentLobbyInfo.gameType = storedGameType;
        }
        
        refreshLobbyInfo();
        refreshStats();
      
        // Set up periodic refresh
        setInterval(() => {
          refreshLobby();
        }, 5000); // Refresh every 5 seconds
      };

      // Handle WebSocket messages from parent frame
      window.addEventListener("message", (event) => {
        if (event.data.type === "websocket") {
          handleMessage(event.data.data);
        }
      });

      function handleMessage(data) {
        try {
          const response = JSON.parse(data);
          console.log("Message from server:", response);

          if (response.message) {
            responseDiv.innerText = response.message;
            setTimeout(() => {
              responseDiv.innerText = "";
            }, 5000);
          }

          if (response.redirect) {
            window.location.href = response.redirect;
          }

          // Handle player list
          if (response.players) {
            updatePlayerList(response.players);
          }

          // Handle lobby info
          if (response.lobbyInfo) {
            updateLobbyInfo(response.lobbyInfo);
          }

          // Handle stats
          if (response.stats) {
            updateStats(response.stats);
          }
        } catch (e) {
          console.error("Error parsing message:", e);
        }
      }

      function updatePlayerList(players) {
        playerListElement.innerHTML = "";

        if (players.length === 0) {
          playerListElement.innerHTML = "<li>No players in lobby</li>";
          return;
        }

        players.forEach((player) => {
          const li = document.createElement("li");
          li.innerHTML = `${player.name} <span class="${
            player.ready ? "player-ready" : "player-not-ready"
          }">(${player.ready ? "Ready" : "Not Ready"})</span>`;
          playerListElement.appendChild(li);
        });
      }

      function updateLobbyInfo(info) {
        currentLobbyInfo = info;
        lobbyTitle.textContent = info.name;
        playerCountDiv.textContent = `Players: ${info.playerCount}/${info.maxPlayers}`;
        gameTypeDiv.textContent = `Game Type: ${info.gameType}`;
        
        // Save game type to localStorage when we get it from the server
        if (info.gameType) {
          localStorage.setItem('currentGameType', info.gameType);
          console.log("Saved game type to localStorage:", info.gameType);
        }
        
        // Add debugging output
        debugLobbyInfo();
      }

      function updateStats(stats) {
        document.getElementById("gamesPlayed").textContent = stats.gamesPlayed;
        document.getElementById("gamesWon").textContent = stats.gamesWon;
        document.getElementById("wallet").textContent = `$${stats.wallet}`;

        // Calculate win rate
        const winRate =
          stats.gamesPlayed > 0
            ? Math.round((stats.gamesWon / stats.gamesPlayed) * 100)
            : 0;
        document.getElementById("winRate").textContent = `${winRate}%`;
      }

      function readyUp() {
        sendToServer(JSON.stringify({ action: "Ready" }));
        isReady = !isReady;
        readyButton.textContent = isReady ? "Cancel Ready" : "Ready Up";
        readyButton.style.backgroundColor = isReady ? "#c0392b" : "#27ae60";
      }

      function refreshStats() {
        sendToServer(JSON.stringify({ action: "ShowStats" }));
      }

      function quitLobby() {
        // Clear the stored game type when leaving the lobby
        localStorage.removeItem('currentGameType');
        sendToServer(JSON.stringify({ action: "Quit" }));
      }

      function refreshLobbyInfo() {
        sendToServer(JSON.stringify({ action: "ShowLobbyInfo" }));
      }

      function showRules() {
        // First try to get game type from currentLobbyInfo
        let gameType = currentLobbyInfo?.gameType;
        
        // If not available, try localStorage
        if (!gameType) {
          gameType = localStorage.getItem('currentGameType');
        }
        
        console.log("Getting rules for game type:", gameType);
        
        let ruleUrl = "https://en.wikipedia.org/wiki/Five-card_draw"; // Default
        
        if (gameType) {
          // Direct match with our known types
          if (gameRuleUrls[gameType]) {
            ruleUrl = gameRuleUrls[gameType];
            console.log("Direct match found for game type:", gameType);
          } 
          // Try Texas Hold'em with different variations
          else if (gameType.toLowerCase().includes("texas") || gameType.toLowerCase().includes("hold")) {
            ruleUrl = "https://en.wikipedia.org/wiki/Texas_hold_%27em";
            console.log("Texas Hold'em variation detected");
          }
          // Try 7 Card Stud with different variations  
          else if (gameType.toLowerCase().includes("7") || gameType.toLowerCase().includes("stud")) {
            ruleUrl = "https://en.wikipedia.org/wiki/Seven-card_stud";
            console.log("7 Card Stud variation detected");
          }
          // Try 5 Card Draw with different variations
          else if (gameType.toLowerCase().includes("5") || gameType.toLowerCase().includes("draw")) {
            ruleUrl = "https://en.wikipedia.org/wiki/Five-card_draw";
            console.log("5 Card Draw variation detected");
          }
          else {
            console.log("No specific match found for type:", gameType);
          }
        } else {
          console.log("No game type available, using default rules");
        }
        
        // Set the iframe source to the Wikipedia URL
        console.log("Setting iframe src to:", ruleUrl);
        rulesFrame.src = ruleUrl;
        rulesModal.style.display = "flex";
      }

      function closeRules() {
        rulesModal.style.display = "none";
      }

      // Send messages through parent using postMessage
      function sendToServer(message) {
        window.parent.postMessage(
          {
            type: "sendWebSocket",
            data: message,
          },
          "*"
        );
      }

      // Close rules modal when clicking outside of it
      window.onclick = function (event) {
        if (event.target === rulesModal) {
          closeRules();
        }
      };

      // Add this function for debugging purposes
      function debugLobbyInfo() {
        console.log("Current Lobby Info:", currentLobbyInfo);
        if (currentLobbyInfo && currentLobbyInfo.gameType) {
          console.log("Game Type:", currentLobbyInfo.gameType);
          console.log("Game Rule URL:", gameRuleUrls[currentLobbyInfo.gameType] || "Not found");
        }
      }
    </script>
  </body>
</html>
