<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Poker Lobby</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        background: #1a2b3c;
        color: white;
        margin: 0;
        padding: 0;
      }

      .container {
        max-width: 1200px;
        margin: 0 auto;
        padding: 20px;
      }

      h1 {
        text-align: center;
        color: #f8c471;
        margin-bottom: 20px;
      }

      .lobby-info {
        background-color: rgba(0, 0, 0, 0.3);
        border-radius: 5px;
        padding: 15px;
        margin-bottom: 20px;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .player-info {
        font-size: 18px;
      }

      .action-panel {
        display: flex;
        gap: 10px;
        margin-bottom: 20px;
      }

      button {
        background-color: #2e86c1;
        color: white;
        border: none;
        padding: 12px 20px;
        border-radius: 5px;
        cursor: pointer;
        font-size: 16px;
        transition: background-color 0.3s;
      }

      button:hover {
        background-color: #3498db;
      }

      button.ready-btn {
        background-color: #27ae60;
      }

      button.ready-btn:hover {
        background-color: #2ecc71;
      }

      button.quit-btn {
        background-color: #c0392b;
      }

      button.quit-btn:hover {
        background-color: #e74c3c;
      }

      .panel {
        background-color: rgba(0, 0, 0, 0.3);
        border-radius: 5px;
        padding: 15px;
        margin-bottom: 20px;
      }

      .panel-header {
        font-size: 18px;
        font-weight: bold;
        margin-bottom: 10px;
        color: #f8c471;
        border-bottom: 1px solid #f8c471;
        padding-bottom: 5px;
      }

      .player-list {
        list-style-type: none;
        padding: 0;
      }

      .player-list li {
        padding: 8px;
        border-bottom: 1px solid rgba(255, 255, 255, 0.1);
      }

      .player-list li:last-child {
        border-bottom: none;
      }

      .player-ready {
        color: #2ecc71;
      }

      .player-not-ready {
        color: #e74c3c;
      }

      .response {
        background-color: rgba(0, 0, 0, 0.5);
        padding: 10px;
        margin: 10px 0;
        border-radius: 5px;
        min-height: 30px;
      }

      .game-rules {
        white-space: pre-line;
      }

      .stats-container {
        display: flex;
        justify-content: space-between;
      }

      .stats-item {
        text-align: center;
        flex: 1;
        padding: 10px;
      }

      .stats-value {
        font-size: 24px;
        font-weight: bold;
        color: #f8c471;
      }

      .stats-label {
        font-size: 14px;
        color: #bdc3c7;
      }

      /* Rules modal styling */
      .modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.7);
        z-index: 100;
        justify-content: center;
        align-items: center;
      }

      .modal-content {
        background-color: #2c3e50;
        border-radius: 8px;
        width: 80%;
        max-width: 800px;
        max-height: 80vh;
        padding: 20px;
        position: relative;
      }

      .close-button {
        position: absolute;
        top: 10px;
        right: 15px;
        font-size: 24px;
        color: #e74c3c;
        cursor: pointer;
        background: none;
        border: none;
        padding: 0;
      }

      .rules-iframe {
        width: 100%;
        height: 500px;
        border: none;
        background-color: white;
      }

      /* Game iframe styling */
      .game-container {
        width: 100%;
        height: 500px;
        margin-top: 20px;
        border-radius: 8px;
        overflow: hidden;
        box-shadow: 0 0 20px rgba(0, 0, 0, 0.5);
      }

      .game-iframe {
        width: 100%;
        height: 100%;
        border: none;
        /* Remove the background color so it doesn't show green */
        background-color: transparent;
        position: relative;
        z-index: 2;
      }

      /* Layout for when game is active */
      .game-active .top-row {
        display: flex;
        gap: 20px;
        margin-bottom: 20px;
      }

      .game-active .top-row .panel {
        flex: 1;
        margin-bottom: 0;
      }

      .row {
        display: flex;
        gap: 20px;
      }

      .col {
        flex: 1;
      }

      /* Add to existing styles */
      /* Game active state adjustments */
      .game-active .container {
        display: flex;
        flex-direction: column;
      }
      
      .game-active .top-section {
        display: flex;
        gap: 20px;
        margin-bottom: 15px;
      }
      
      .game-active .info-panel {
        flex: 2;
      }
      
      .game-active .stats-panel {
        flex: 3;
      }
      
      .game-active .game-container {
        /* No need for display: block here since we want it always visible */
        height: 500px;
        margin-bottom: 15px;
      }
      
      .game-active .player-panel {
        margin-top: 10px;
      }
      
      .game-active .lobby-controls {
        display: none;
      }

      .hidden {
        display: none !important;
      }
      
      .panel.minimized {
        padding: 10px;
      }
      
      .panel.minimized .panel-header {
        margin-bottom: 0;
        padding-bottom: 0;
        border-bottom: none;
      }

      .panel-toggle {
        float: right;
        cursor: pointer;
        user-select: none;
      }

      .game-loading {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        display: flex;
        justify-content: center;
        align-items: center;
        background-color: #15803d;
        color: white;
        font-size: 20px;
        z-index: 1;
      }
    </style>
  </head>
  <body>
    <div class="container" id="mainContainer">
      <h1 id="lobbyTitle">Game Lobby</h1>

      <div class="lobby-info">
        <div class="player-info" id="playerCount">Players: 0/0</div>
        <div class="player-info" id="gameType">Game Type: Loading...</div>
      </div>

      <div class="response" id="response"></div>

      <div class="action-panel lobby-controls" id="lobbyControls">
        <button onclick="readyUp()" class="ready-btn" id="readyButton">
          Ready Up
        </button>
        <button onclick="showRules()" class="rules-btn">Rules</button>
        <button onclick="quitLobby()" class="quit-btn">Leave Lobby</button>
      </div>

      <div class="top-section" id="topSection">
        <div class="col info-panel">
          <div class="panel">
            <div class="panel-header">Players in Lobby <span class="panel-toggle" id="playerListToggle">[-]</span></div>
            <div id="playerListContent">
              <ul class="player-list" id="playerList">
                <li>Loading players...</li>
              </ul>
            </div>
          </div>
        </div>
        <div class="col stats-panel">
          <div class="panel" id="statsPanel">
            <div class="panel-header">Your Statistics <span class="panel-toggle" id="statsToggle">[-]</span></div>
            <div id="statsContent">
              <div class="stats-container">
                <div class="stats-item">
                  <div class="stats-value" id="gamesPlayed">0</div>
                  <div class="stats-label">Games Played</div>
                </div>
                <div class="stats-item">
                  <div class="stats-value" id="gamesWon">0</div>
                  <div class="stats-label">Games Won</div>
                </div>
                <div class="stats-item">
                  <div class="stats-value" id="winRate">0%</div>
                  <div class="stats-label">Win Rate</div>
                </div>
                <div class="stats-item">
                  <div class="stats-value" id="wallet">$0</div>
                  <div class="stats-label">Wallet</div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Game iframe container -->
      <div class="game-container" id="gameContainer">
        <div id="gameLoading" class="game-loading">Loading poker table...</div>
        <iframe id="gameFrame" class="game-iframe" src="about:blank"></iframe>
      </div>

      <!-- Game controls appear when game is active -->
      <div class="action-panel game-controls hidden" id="gameControls">
        <button onclick="showRules()" class="rules-btn">Rules</button>
        <button onclick="quitLobby()" class="quit-btn">Leave Game</button>
      </div>
    </div>

    <!-- Rules Modal -->
    <div id="rulesModal" class="modal">
      <div class="modal-content">
        <button class="close-button" onclick="closeRules()">&times;</button>
        <h2>Game Rules</h2>
        <iframe id="rulesFrame" class="rules-iframe" src="about:blank"></iframe>
      </div>
    </div>

    <script>
      const responseDiv = document.getElementById("response");
      const playerCountDiv = document.getElementById("playerCount");
      const gameTypeDiv = document.getElementById("gameType");
      const playerListElement = document.getElementById("playerList");
      const lobbyTitle = document.getElementById("lobbyTitle");
      const readyButton = document.getElementById("readyButton");
      const rulesModal = document.getElementById("rulesModal");
      const rulesFrame = document.getElementById("rulesFrame");
      const mainContainer = document.getElementById("mainContainer");
      const gameContainer = document.getElementById("gameContainer");
      const gameFrame = document.getElementById("gameFrame");
      const lobbyControls = document.getElementById("lobbyControls");

      let isReady = false;
      let currentLobbyInfo = null;
      let gameActive = false;

      // Add these constants for the new UI elements
      const topSection = document.getElementById("topSection");
      const playerListToggle = document.getElementById("playerListToggle");
      const statsToggle = document.getElementById("statsToggle");
      const playerListContent = document.getElementById("playerListContent");
      const statsContent = document.getElementById("statsContent");
      const gameControls = document.getElementById("gameControls");

      // Update the game rule URLs to use Wikipedia
      const gameRuleUrls = {
        "5 Card Draw": "https://en.wikipedia.org/wiki/Five-card_draw",
        "7 Card Stud": "https://en.wikipedia.org/wiki/Seven-card_stud",
        "Texas Hold'em": "https://en.wikipedia.org/wiki/Texas_hold_%27em"
      };
      
      // Map game types to their corresponding HTML files
      const gameHtmlFiles = {
        "5 Card Draw": "five_card.html",
        "7 Card Stud": "seven_card.html",
        "Texas Hold'em": "texas_holdem.html" 
      };

      // Update the window.onload function
      window.onload = function () {
        // Check if we have a stored game type
        const storedGameType = localStorage.getItem('currentGameType');
        if (storedGameType) {
          console.log("Found stored game type:", storedGameType);
          currentLobbyInfo = currentLobbyInfo || {};
          currentLobbyInfo.gameType = storedGameType;
          
          // Initialize the game iframe with the appropriate game
          loadGameFrame(storedGameType);
        } else {
          // Default to 5 Card Draw if no stored game type
          loadGameFrame("5 Card Draw");
        }
        
        refreshLobbyInfo();
        refreshStats();
      
        // Set up periodic refresh
        setInterval(() => {
          updateInput();
        }, 100);
      };

      // Add this function to load the appropriate game iframe
      function loadGameFrame(gameType) {
        const gameFrame = document.getElementById("gameFrame");
        let gameUrl = "five_card.html"; // Default
        
        // Show loading indicator
        document.getElementById("gameLoading").style.display = "flex";
        
        // Clear any existing content first
        gameFrame.src = "about:blank";
        
        // Give a small delay before loading new content
        setTimeout(() => {
          if (gameType.toLowerCase().includes("texas") || gameType.toLowerCase().includes("hold")) {
            gameUrl = "texas_holdem.html";
          } else if (gameType.toLowerCase().includes("7") || gameType.toLowerCase().includes("stud")) {
            gameUrl = "seven_card.html";
          } else if (gameType.toLowerCase().includes("5") || gameType.toLowerCase().includes("draw")) {
            gameUrl = "five_card.html";
          }
          
          console.log(`Loading game frame: ${gameUrl} for type: ${gameType}`);
          // Load the file from /static/ directory instead of the root path
          gameFrame.src = `/static/${gameUrl}`;
          
          // Add event listener to detect load errors
          gameFrame.onerror = function() {
            console.error(`Failed to load game frame: ${gameUrl}`);
            document.getElementById("gameLoading").textContent = 
              `Error loading game. Please refresh the page.`;
          };
          
          // Add onload handler to hide loading message
          gameFrame.onload = function() {
            document.getElementById("gameLoading").style.display = "none";
            console.log(`Successfully loaded game frame: ${gameUrl}`);
          };
        }, 100);
      }

      // Handle WebSocket messages from parent frame
      window.addEventListener("message", (event) => {
        if (event.data.type === "websocket") {
          handleMessage(event.data.data);
        }
      });

      function handleMessage(data) {
        try {
          const response = JSON.parse(data);
          console.log("Message from server:", response);

          if (response.message) {
            responseDiv.innerText = response.message;
            setTimeout(() => {
              responseDiv.innerText = "";
            }, 5000);
          }

          if (response.redirect) {
            // Navigate using parent frame
            window.parent.navigate(response.redirect);
          }

          // Handle player list
          if (response.players) {
            updatePlayerList(response.players);
            
            // Check if all players are ready
            checkAllPlayersReady(response.players);
          }

          // Handle lobby info
          if (response.lobbyInfo) {
            updateLobbyInfo(response.lobbyInfo);
          }

          // Handle stats
          if (response.stats) {
            updateStats(response.stats);
          }
          
          // Handle game start
          if (response.gameStarted) {
            startGame();
          }
        } catch (e) {
          console.error("Error parsing message:", e);
        }
      }

      function updatePlayerList(players) {
        playerListElement.innerHTML = "";

        if (players.length === 0) {
          playerListElement.innerHTML = "<li>No players in lobby</li>";
          return;
        }

        players.forEach((player) => {
          const li = document.createElement("li");
          li.innerHTML = `${player.name} <span class="${
            player.ready ? "player-ready" : "player-not-ready"
          }">(${player.ready ? "Ready" : "Not Ready"})</span>`;
          playerListElement.appendChild(li);
        });
        
        // Send player data to the game iframe
        sendGameCommand("updatePlayers", { players: players });
      }
      
      function checkAllPlayersReady(players) {
        // Only check if game isn't already active
        if (gameActive) return;
        
        if (players.length >= 2) {
          const allReady = players.every(player => player.ready);
          if (allReady) {
            console.log("All players are ready, starting game...");
            startGame();
          }
        }
      }
      
      // Modified startGame function
      function startGame() {
        sendToServer(JSON.stringify({ action: "StartGame" }));
        if (gameActive) return; // Prevent multiple starts
        
        gameActive = true;
        
        // Update UI elements
        mainContainer.classList.add("game-active");
        lobbyControls.classList.add("hidden");
        gameControls.classList.remove("hidden");
        
        // Send a message to the game iframe to start the game
        sendGameCommand("startGame", {
          players: currentLobbyInfo.players,
          gameType: currentLobbyInfo.gameType
        });
        
        console.log(`Game started: ${currentLobbyInfo.gameType}`);
      }

      // Add this function to send messages to the game iframe
      function sendGameCommand(command, data) {
        const gameFrame = document.getElementById("gameFrame");
        if (gameFrame && gameFrame.contentWindow) {
          gameFrame.contentWindow.postMessage({
            type: "command",
            command: command,
            data: data
          }, "*");
        }
      }

      function updateLobbyInfo(info) {
        // Check if game type has changed
        const gameTypeChanged = currentLobbyInfo?.gameType !== info.gameType;
        
        // Update current lobby info
        currentLobbyInfo = info;
        lobbyTitle.textContent = info.name;
        playerCountDiv.textContent = `Players: ${info.playerCount}/${info.maxPlayers}`;
        gameTypeDiv.textContent = `Game Type: ${info.gameType}`;
        
        // Save game type to localStorage
        if (info.gameType) {
          localStorage.setItem('currentGameType', info.gameType);
          console.log("Saved game type to localStorage:", info.gameType);
        }
        
        // If game type changed, reload the appropriate game frame
        if (gameTypeChanged) {
          loadGameFrame(info.gameType);
        }
        
        // Send updated player list to the game frame
        if (info.players) {
          sendGameCommand("updatePlayers", {
            players: info.players
          });
        }
        
        // Add debugging output
        debugLobbyInfo();
      }

      function updateStats(stats) {
        document.getElementById("gamesPlayed").textContent = stats.gamesPlayed;
        document.getElementById("gamesWon").textContent = stats.gamesWon;
        document.getElementById("wallet").textContent = `$${stats.wallet}`;

        // Calculate win rate
        const winRate =
          stats.gamesPlayed > 0
            ? Math.round((stats.gamesWon / stats.gamesPlayed) * 100)
            : 0;
        document.getElementById("winRate").textContent = `${winRate}%`;
      }

      function readyUp() {
        sendToServer(JSON.stringify({ action: "Ready" }));
        isReady = !isReady;
        readyButton.textContent = isReady ? "Cancel Ready" : "Ready Up";
        readyButton.style.backgroundColor = isReady ? "#c0392b" : "#27ae60";
      }

      function refreshStats() {
        sendToServer(JSON.stringify({ action: "ShowStats" }));
      }

      function quitLobby() {
        // Clear the stored game type when leaving the lobby
        localStorage.removeItem('currentGameType');
        sendToServer(JSON.stringify({ action: "Quit" }));
      }
      
      function refreshLobby() {
        sendToServer(JSON.stringify({ action: "ShowPlayers" }));
      }

      function refreshLobbyInfo() {
        sendToServer(JSON.stringify({ action: "ShowLobbyInfo" }));
      }

      function updateInput(){
        sendToServer(JSON.stringify({ action: "UpdateInput" }));
      }

      function showRules() {
        // First try to get game type from currentLobbyInfo
        let gameType = currentLobbyInfo?.gameType;
        
        // If not available, try localStorage
        if (!gameType) {
          gameType = localStorage.getItem('currentGameType');
        }
        
        console.log("Getting rules for game type:", gameType);
        
        let ruleUrl = "https://en.wikipedia.org/wiki/Five-card_draw"; // Default
        
        if (gameType) {
          // Direct match with our known types
          if (gameRuleUrls[gameType]) {
            ruleUrl = gameRuleUrls[gameType];
            console.log("Direct match found for game type:", gameType);
          } 
          // Try Texas Hold'em with different variations
          else if (gameType.toLowerCase().includes("texas") || gameType.toLowerCase().includes("hold")) {
            ruleUrl = "https://en.wikipedia.org/wiki/Texas_hold_%27em";
            console.log("Texas Hold'em variation detected");
          }
          // Try 7 Card Stud with different variations  
          else if (gameType.toLowerCase().includes("7") || gameType.toLowerCase().includes("stud")) {
            ruleUrl = "https://en.wikipedia.org/wiki/Seven-card_stud";
            console.log("7 Card Stud variation detected");
          }
          // Try 5 Card Draw with different variations
          else if (gameType.toLowerCase().includes("5") || gameType.toLowerCase().includes("draw")) {
            ruleUrl = "https://en.wikipedia.org/wiki/Five-card_draw";
            console.log("5 Card Draw variation detected");
          }
          else {
            console.log("No specific match found for type:", gameType);
          }
        } else {
          console.log("No game type available, using default rules");
        }
        
        // Set the iframe source to the Wikipedia URL
        console.log("Setting iframe src to:", ruleUrl);
        rulesFrame.src = ruleUrl;
        rulesModal.style.display = "flex";
      }

      function closeRules() {
        rulesModal.style.display = "none";
      }

      // Send messages through parent using postMessage
      function sendToServer(message) {
        window.parent.postMessage(
          {
            type: "sendWebSocket",
            data: message,
          },
          "*"
        );
      }

      // Close rules modal when clicking outside of it
      window.onclick = function (event) {
        if (event.target === rulesModal) {
          closeRules();
        }
      };

      // Add this function for debugging purposes
      function debugLobbyInfo() {
        console.log("Current Lobby Info:", currentLobbyInfo);
        if (currentLobbyInfo && currentLobbyInfo.gameType) {
          console.log("Game Type:", currentLobbyInfo.gameType);
          console.log("Game Rule URL:", gameRuleUrls[currentLobbyInfo.gameType] || "Not found");
        }
      }

      // Add toggle functionality for panels
      playerListToggle.addEventListener("click", function() {
        togglePanel(playerListContent, playerListToggle);
      });

      statsToggle.addEventListener("click", function() {
        togglePanel(statsContent, statsToggle);
      });

      function togglePanel(contentElement, toggleElement) {
        const isOpen = contentElement.style.display !== "none";
        
        if (isOpen) {
          contentElement.style.display = "none";
          toggleElement.textContent = "[+]";
          toggleElement.parentElement.parentElement.classList.add("minimized");
        } else {
          contentElement.style.display = "block";
          toggleElement.textContent = "[-]";
          toggleElement.parentElement.parentElement.classList.remove("minimized");
        }
      }

      // Add this to the lobby.html script
      gameFrame.onload = function() {
        // Hide loading message when iframe loads
        document.getElementById("gameLoading").style.display = "none";
      };
    </script>
  </body>
</html>