<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>5 Card Draw Poker</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #1e293b;
            color: white;
            overflow: hidden;
        }

        #debug {
            position: absolute;
            top: 5px;
            right: 5px;
            background: rgba(0,0,0,0.7);
            padding: 5px;
            border-radius: 5px;
            font-size: 12px;
            z-index: 100;
        }

        .game-container {
            width: 100%;
            height: 100vh;
            display: flex;
            flex-direction: column;
        }

        .game-header {
            background-color: #0f2937;
            color: #f8c471;
            padding: 10px;
            text-align: center;
            font-size: 20px;
            border-bottom: 2px solid #713f12;
        }

        .table-area {
            flex: 1;
            position: relative;
            margin: 20px;
            background-color: #15803d;
            border-radius: 50%;
            border: 10px solid #713f12;
            display: flex;
            justify-content: center;
            align-items: center;
            box-shadow: inset 0 0 30px rgba(0,0,0,0.5);
        }

        .table-center {
            text-align: center;
        }

        .pot {
            font-size: 22px;
            font-weight: bold;
            color: #fcd34d;
            margin-bottom: 15px;
            text-shadow: 1px 1px 2px #000;
        }

        .player-positions {
            position: absolute;
            width: 100%;
            height: 100%;
        }

        .player-spot {
            position: absolute;
            width: 120px;
            padding: 8px;
            background-color: rgba(0,0,0,0.6);
            border-radius: 5px;
            text-align: center;
        }

        /* Player positions around the table */
        .player-spot:nth-child(1), 
        .player-spot:nth-child(2), 
        .player-spot:nth-child(3), 
        .player-spot:nth-child(4), 
        .player-spot:nth-child(5) {
            position: absolute;
        }
        
        .player-spot {
            position: absolute;
            width: 120px;
            padding: 8px;
            background-color: rgba(0,0,0,0.6);
            border-radius: 5px;
            text-align: center;
        }
        
        .current-player {
            background-color: rgba(0,0,0,0.8);
            border: 2px solid #f8c471;
        }

        .player-name {
            font-weight: bold;
            color: #f8c471;
            margin-bottom: 5px;
            word-break: break-word;
        }

        .player-chips {
            font-size: 14px;
            color: #bdc3c7;
        }

        .player-cards {
            display: flex;
            justify-content: center;
            gap: 5px;
            margin-top: 5px;
        }

        /* Add to the style section in five_card.html */
        .card {
            display: inline-block;
            width: 35px;
            height: 50px;
            margin: 0 2px;
            background-color: #fff;
            border: 1px solid #333;
            border-radius: 4px;
            text-align: center;
            line-height: 50px;
            font-weight: bold;
            font-size: 14px;
            box-shadow: 1px 1px 3px rgba(0,0,0,0.5);
            position: relative;
        }

        .card.facedown {
            background: linear-gradient(135deg, #1e40af 25%, #1e3a8a 25%, #1e3a8a 50%, #1e40af 50%, #1e40af 75%, #1e3a8a 75%);
            background-size: 20px 20px;
            color: transparent;
        }

        .card-placeholder {
            background-color: rgba(255, 255, 255, 0.2);
            border: 1px dashed rgba(255, 255, 255, 0.5);
            color: transparent;
        }

        .red-card {
            color: #cc0000;
        }

        .black-card {
            color: #000;
        }

        .folded-indicator {
            display: block;
            color: #ff4444;
            font-weight: bold;
            text-transform: uppercase;
            font-size: 14px;
        }

        .player-folded {
            opacity: 0.7;
        }

        /* Add style for the player's own cards for better visibility */
        .current-player .card:not(.facedown) {
            transform: translateY(-5px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.3);
            border: 2px solid #f8c471;
        }

        .game-status {
            position: absolute;
            bottom: 15px;
            left: 15px;
            padding: 8px 12px;
            background-color: rgba(0,0,0,0.7);
            border-radius: 4px;
        }
    </style>
</head>
<body>
    <div id="debug">Loading 5 Card Draw...</div>
    
    <div class="game-container">
        <div class="game-header">5 Card Draw Poker</div>
        
        <div class="table-area">
            <div class="table-center">
                <div class="pot">Pot: $0</div>
            </div>
            
            <div class="player-positions" id="playerPositions">
                <!-- Player spots will be generated here -->
            </div>
            
            <div class="game-status" id="gameStatus">
                Waiting for players...
            </div>
        </div>
    </div>

    <script>
        // Debug element for troubleshooting
        const debug = document.getElementById('debug');
        
        console.log('Game frame loaded');
        
        // Game elements
        const playerPositions = document.getElementById('playerPositions');
        const gameStatus = document.getElementById('gameStatus');

        window.addEventListener("message", (event) => {
            console.log("Received message from parent frame: ", event);
            if (event.data.type === "command") {
                handleMessage(event.data);
            }

            if (event.data.type === "wsMessage"){
                handleServerMessage(event.data.message);
            }
        });

        function handleServerMessage(message) {
            try {
                const data = JSON.parse(message);
                console.log("Server message received:", data);
                
                // Handle hands update from specific hand update messages
                if (data.type === "handsUpdate") {
                    updatePlayerHands(data.hands);
                } 
                // Handle player updates which now include hands
                else if (data.type === "playerUpdate" && data.players) {
                    // Format the data for updatePlayers
                    updatePlayers(data.players);
                    
                    // Format hand data for updatePlayerHands if any players have hands
                    const handsData = data.players
                        .filter(player => player.hand && player.hand.length > 0)
                        .map(player => ({
                            playerName: player.name,
                            hand: player.hand,
                            state: player.state
                        }));
                        
                    if (handsData.length > 0) {
                        updatePlayerHands(handsData);
                    }
                }
            } catch (error) {
                console.error("Error processing server message:", error);
            }
        }
        
        function handleMessage(data) {
            if (data.command === "updatePlayers") {
                updatePlayers(data.data.players);
            } else if (data.command === "startGame") {
                startGame(data.data);
            }
        }
        
        // Update player information
        function updatePlayers(players) {
            // Safety checks for undefined or non-array
            if (!players) {
                console.log('Warning: players data is undefined');
                playerPositions.innerHTML = '';
                return;
            }

            if (!Array.isArray(players)) {
                console.log('Warning: players is not an array, attempting to fix');
                if (typeof players === 'object') {
                    players = [players];
                } else {
                    playerPositions.innerHTML = '';
                    return;
                }
            }
            
            console.log(`Updating ${players.length} players`);
            
            // Clear existing players
            playerPositions.innerHTML = '';
            
            if (players.length === 0) return;
            
            // Get stored current player name
            const storedCurrentPlayerName = localStorage.getItem('currentPlayerName');
            console.log("Stored current player name: ", storedCurrentPlayerName);
            
            // Find current player index in original array
            let currentPlayerIndex = -1;
            if (storedCurrentPlayerName) {
                currentPlayerIndex = players.findIndex(p => p.name === storedCurrentPlayerName);
            }
            
            // If current player not found, use first player
            if (currentPlayerIndex === -1) {
                currentPlayerIndex = 0;
            }
            
            // Position players around the table, maintaining the original order
            const totalPlayers = players.length;
            
            // Calculate the angle step based on total players
            const angleStep = 360 / totalPlayers;
            
            // Create and position all players, starting with the current player at bottom
            for (let i = 0; i < totalPlayers; i++) {
                // Calculate the player's position in the original array
                const playerIndex = (currentPlayerIndex + i) % totalPlayers;
                const player = players[playerIndex];
                
                // Calculate the angle, starting at 90 degrees (bottom)
                const angle = (90 + (i * angleStep)) % 360;
                
                // Create the player spot
                const playerSpot = createPlayerSpot(player, angle);
                
                // Add "current-player" class if this is the current player
                if (playerIndex === currentPlayerIndex) {
                    playerSpot.classList.add('current-player');
                }
                
                playerPositions.appendChild(playerSpot);
            }
        }

        // Create a player spot with calculated position
        function createPlayerSpot(player, angle) {
            const playerSpot = document.createElement('div');
            playerSpot.className = 'player-spot';
            
            // Create HTML for player info
            playerSpot.innerHTML = `
                <div class="player-name">${player.name}</div>
                <div class="player-chips">$${player.chips || player.wallet || 1000}</div>
                <div class="player-cards">
                    <!-- Cards will be added dynamically only if player has cards -->
                </div>
            `;
            
            // Position based on angle
            const radius = 40; // % of container
            const radians = angle * (Math.PI / 180);
            const x = 50 + radius * Math.cos(radians);
            const y = 50 + radius * Math.sin(radians);
            
            playerSpot.style.left = `${x}%`;
            playerSpot.style.top = `${y}%`;
            playerSpot.style.transform = 'translate(-50%, -50%)';
            
            // Special styling for current player (bottom position)
            if (angle === 90) {
                playerSpot.style.bottom = '10px';
                playerSpot.style.left = '50%';
                playerSpot.style.top = 'auto';
                playerSpot.style.transform = 'translateX(-50%)';
            }
            
            // Add default face down cards if this is not an empty hand update
            const cardsContainer = playerSpot.querySelector('.player-cards');
            
            // Only add placeholder cards during the game
            const gameIsActive = gameStatus.textContent !== 'Waiting for players...';
            
            if (gameIsActive && (!player.hand || player.hand.length === 0)) {
                // Add placeholders for cards when in game but no cards received yet
                for (let i = 0; i < 5; i++) {
                    const card = document.createElement('div');
                    card.className = 'card facedown';
                    card.textContent = '?';
                    cardsContainer.appendChild(card);
                }
            }
            
            return playerSpot;
        }
        
        // Start the game
        function startGame(data) {
            console.log('Starting game');
            gameStatus.textContent = 'Game in progress...';
            
            // Log what we received to debug
            console.log("Game start data received:", data);
            
            // Ensure data has the correct structure
            if (data && Array.isArray(data.players)) {
                updatePlayers(data.players);
            } else if (data && data.players) {
                // If data.players exists but is not an array, try to use it
                console.log('Player data exists but may have wrong format');
                updatePlayers(data.players);
            } else {
                // Use empty array as fallback
                console.log('Warning: No player data available for game start');
                updatePlayers([]);
            }
        }
        
        // Initialize when the page loads
        window.onload = function() {
            console.log('Five Card Draw interface initialized');
            
            // Let the parent frame know we're ready
            window.parent.postMessage({
                type: 'gameFrameReady',
                gameType: '5 Card Draw'
            }, '*');
        };

        // Function to update player hands based on server data
        function updatePlayerHands(hands) {
            console.log("Updating player hands:", hands);
            
            if (!hands || !Array.isArray(hands) || hands.length === 0) {
                console.log("No hand data to update");
                return;
            }
            
            // Get all player spots
            const playerSpots = document.querySelectorAll('.player-spot');
            
            // Map player names to their DOM elements
            const playerElements = {};
            playerSpots.forEach(spot => {
                const nameElement = spot.querySelector('.player-name');
                if (nameElement) {
                    playerElements[nameElement.textContent] = spot;
                }
            });
            
            // Update each player's cards
            hands.forEach(playerHand => {
                const playerName = playerHand.playerName;
                const hand = playerHand.hand || [];
                const state = playerHand.state;
                
                const playerElement = playerElements[playerName];
                if (!playerElement) return;
                
                // Get the cards container for this player
                const cardsContainer = playerElement.querySelector('.player-cards');
                if (!cardsContainer) return;
                
                // Clear existing cards
                cardsContainer.innerHTML = '';
                
                // If player folded, show folded state
                if (state === 1) { // FOLDED = 1
                    const foldedDiv = document.createElement('div');
                    foldedDiv.className = 'folded-indicator';
                    foldedDiv.textContent = 'FOLDED';
                    cardsContainer.appendChild(foldedDiv);
                    playerElement.classList.add('player-folded');
                    return;
                }
                
                // Remove folded class if it exists
                playerElement.classList.remove('player-folded');
                
                // Skip if hand is empty - don't show any cards
                if (hand.length === 0) {
                    return;
                }
                
                // Create and add cards
                const maxCards = 5; // 5 Card Draw has 5 cards
                const cardCount = Math.min(hand.length, maxCards);
                
                for (let i = 0; i < cardCount; i++) {
                    const card = document.createElement('div');
                    card.className = 'card';
                    
                    // If this is the current player, show the actual card
                    // Otherwise keep it face down
                    const storedPlayerName = localStorage.getItem('currentPlayerName');
                    
                    if (playerName === storedPlayerName) {
                        card.textContent = cardToString(hand[i]);
                        card.dataset.cardValue = hand[i];
                        card.classList.add(getCardColor(hand[i]));
                    } else {
                        card.textContent = '?';
                        card.classList.add('facedown');
                    }
                    
                    cardsContainer.appendChild(card);
                }
                
                // Fill remaining slots with empty placeholders if needed
                for (let i = cardCount; i < maxCards; i++) {
                    const emptyCard = document.createElement('div');
                    emptyCard.className = 'card card-placeholder';
                    cardsContainer.appendChild(emptyCard);
                }
            });
        }

        // Helper function to convert card value to string
        function cardToString(cardValue) {
            if (cardValue === undefined || cardValue === null) return '?';
            
            // Extract suit (0-3) and rank (0-12)
            const suit = Math.floor(cardValue / 13);
            const rank = cardValue % 13;
            
            // Rank symbols
            const ranks = ['2', '3', '4', '5', '6', '7', '8', '9', '10', 'J', 'Q', 'K', 'A'];
            
            // Suit symbols
            const suits = ['♠', '♥', '♦', '♣'];
            
            return ranks[rank] + suits[suit];
        }

        // Helper function to determine card color based on suit
        function getCardColor(cardValue) {
            if (cardValue === undefined || cardValue === null) return '';
            
            const suit = Math.floor(cardValue / 13);
            // Hearts and diamonds are red, spades and clubs are black
            return (suit === 1 || suit === 2) ? 'red-card' : 'black-card';
        }
    </script>
</body>
</html>